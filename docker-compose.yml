version: "3.8"

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: utopia-db
    environment:
      POSTGRES_USER: utopia
      POSTGRES_PASSWORD: utopia_dev_password
      POSTGRES_DB: terminal_utopia
    ports:
      - "5433:5432"
    # No volumes - database recreates from scratch each time
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U utopia -d terminal_utopia"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: utopia-app
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "3001:3001"
    environment:
      # Database connection
      DATABASE_URL: postgresql://utopia:utopia_dev_password@db:5432/terminal_utopia

      # Server configuration
      PORT: 3001
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:3001

      # JWT Secret (use a secure value for production)
      JWT_SECRET: dev_jwt_secret_change_in_production

      # Firebase configuration (add your values here)
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-}
      FIREBASE_PRIVATE_KEY: ${FIREBASE_PRIVATE_KEY:-}
      FIREBASE_CLIENT_EMAIL: ${FIREBASE_CLIENT_EMAIL:-}
    volumes:
      # Mount source code for hot reload during development
      - .:/app
      # Exclude node_modules
      - /app/node_modules
    stdin_open: true
    tty: true
